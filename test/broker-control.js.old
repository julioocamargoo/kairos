/* eslint-disable */
const chai = require('chai');
const dirtyChai = require('dirty-chai');
const simple = require('simple-mock');
const { expect } = chai;
chai.use(dirtyChai);

const BrokerControl = require('../app/broker-control.js');

const logSpy = simple.spy(() => { });
const scBrokerSpy = simple.spy(() => { });
const pid = 1234;

describe('BrokerControl', () => {

  describe('constructor', () => {
    it('should instanciate the class', () => {
      const BrokerControl = new BrokerControl(
        logSpy,
        scBrokerSpy,
        pid
      );
      expect(typeof BrokerControl).to.equal('object');
      expect(typeof BrokerControl.listen).to.equal('function');
    });
  });

  describe('publish', () => {
    it('should listen and return true', () => {
      const ScServer = new Object();
      simple.mock(ScServer, 'publish');
      ScServer.publish.returnWith(true);
      const objectSocket = {
        exchange: ScServer,
      };
      const BrokerControl = new BrokerControl(
        logSpy,
        objectSocket,
        pid
      );
      result = BrokerControl.publish('channel1', 'message');
      expect(typeof result).to.equal('boolean');
      expect(result).to.equal(true);
    });

    it('error on publish return false', () => {
      const ScServer2 = new Object();
      simple.mock(ScServer2, 'publish');
      ScServer2.publish.throwWith(new Error());
      const objectSocket2 = {
        exchange: ScServer2,
      };
      const BrokerControl = new BrokerControl(
        logSpy,
        objectSocket2
      );
      result = BrokerControl.publish('channel1', 'message');
      expect(typeof result).to.equal('boolean');
      expect(result).to.equal(false);
    });

  });

  describe('emit', () => {

    it('should emit and return true', () => {
      const ScServer3 = new Object();
      simple.mock(ScServer3, 'emit');
      ScServer3.emit.returnWith(true);
      const objectSocket3 = {
        clients: {
          ScServer3,
          ScServer3
        }
      };
      const BrokerControl3 = new BrokerControl(
        logSpy,
        objectSocket3
      );
      result = BrokerControl3.emit('message');
      expect(typeof result).to.equal('boolean');
      expect(result).to.equal(true);
    });

    it('should not emit and return false', () => {
      const ScServer4 = new Object();
      simple.mock(ScServer4, 'emit');
      ScServer4.emit.throwWith(new Error());
      const objectSocket4 = {
        clients: {
          ScServer4,
          ScServer4
        }
      };
      const BrokerControl4 = new BrokerControl(
        logSpy,
        objectSocket4
      );
      result = BrokerControl4.emit('message');
      expect(typeof result).to.equal('boolean');
      expect(result).to.equal(false);
    });

  });

  describe('listen', () => {

    it('should listen and return true', () => {
      const ScServer5 = new Object();
      simple.mock(ScServer5, 'on');
      ScServer5.on.returnWith(true);
      const BrokerControl5 = new BrokerControl(
        logSpy,
        ScServer5
      );
      result = BrokerControl5.listen();
      expect(typeof result).to.equal('boolean');
      expect(result).to.equal(true);
    });

    it('should not listen and return false', () => {
      const ScServer6 = new Object();
      simple.mock(ScServer6, 'on');
      ScServer6.on.throwWith(new Error());
      const BrokerControl6 = new BrokerControl(
        logSpy,
        ScServer6
      );
      result = BrokerControl6.listen((isValid) => {
        assert.equal(isValid, true);
        done();
      });
      expect(typeof result).to.equal('boolean');
      expect(result).to.equal(false);
    });

  });

});

